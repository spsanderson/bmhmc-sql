# Lib Load ----
if(!require(pacman)) install.packages("pacman")
pacman::p_load(
    "tidyverse"
    , "DBI"
    , "odbc"
    , "RDCOMClient"
    , "janitor"
    , "RDCOMClient"
)

# DB Connection ----
db_con <- dbConnect(
    odbc(),
    Driver = "SQL Server",
    Server = "BMH-HIDB",
    Database = "SMSPHDSSS0X0",
    Trusted_Connection = T
)

# Data ----
# Use File: congenital_malformations.sql
query <- dbGetQuery(
    conn = db_con
    , statement = paste0(
        "
        DECLARE @ThisDate DATE;
        DECLARE @START DATE;
        DECLARE @END DATE;
        
        SET @ThisDate = GETDATE();
        SET @START = dateadd(mm, datediff(mm, 0, @ThisDate) - 1, 0);
        SET @END = dateadd(mm, datediff(mm, 0, @ThisDate), 0);
        SELECT Med_Rec_No,
        	PtNo_Num,
        	Adm_Date,
        	Dsch_Date,
        	Pt_Age
        FROM smsdss.BMH_PLM_PtAcct_V
        WHERE Pt_No IN (
        		SELECT pt_id
        		FROM smsmir.dx_grp
        		WHERE dx_cd IN (
        				'D82.1', 'E25.0', 'E25.8', 'E25.9', 'E34.3', 'E34.50', 'E34.51', 'E34.52', 'E78.72', 'G12.0', 'G12.1', 'G12.9', 'G60.0', 'G60.1', 'G60.2', 'G71.00', 'G71.01', 'G71.02', 'G71.09', 'G71.11', 'G71.12', 'G71.13', 'G71.19', 'G71.2', 'G71.3', 'G71.8', 'G71.9', 'K40.00', 'K40.10', 'K40.20', 'K40.30', 'K40.40', 'K40.90', 'K41.00', 'K41.10', 'K41.20', 'K41.30', 'K41.40', 'K41.90', 'L05.91', 'L05.92', 'L81.3', 'L81.4', 'L81.9', 'M26.01', 'M26.02', 'M26.03', 'M26.04', 'M26.05', 'M26.06', 'M26.09', 'M26.19', 'O36.4XX0', 'O36.4XX1', 'O36.4XX2', 'O36.4XX3', 'O36.4XX4', 'O36.4XX5', 'O36.4XX9', 'P02.8', 'P35.0', 'P35.1', 'P35.2', 'P35.3', 'P35.4', 'P35.8', 'P35.9', 'P37.0', 'P37.1', 'P95', 'Q00.0', 'Q00.1', 'Q00.2', 'Q01.0', 'Q01.1', 'Q01.2', 'Q01.8', 'Q01.9', 'Q02', 'Q03.0', 'Q03.1', 'Q03.8', 'Q03.9', 'Q04.0', 'Q04.1', 'Q04.2', 'Q04.3', 'Q04.4', 'Q04.5', 'Q04.6', 'Q04.8', 'Q04.9', 'Q05.0', 'Q05.1', 'Q05.2', 'Q05.3', 'Q05.4', 'Q05.5', 'Q05.6', 'Q05.7', 'Q05.8', 'Q05.9', 'Q06.0', 'Q06.1', 'Q06.2', 'Q06.3', 'Q06.4', 'Q06.8', 'Q06.9', 'Q07.00', 'Q07.01', 'Q07.02', 'Q07.03', 'Q07.8', 'Q07.9', 'Q10.0', 
        				'Q10.1', 'Q10.2', 'Q10.3', 'Q10.4', 'Q10.5', 'Q10.6', 'Q10.7', 'Q11.0', 'Q11.1', 'Q11.2', 'Q11.3', 'Q12.0', 'Q12.1', 'Q12.2', 'Q12.3', 'Q12.4', 'Q12.8', 'Q12.9', 'Q13.0', 'Q13.1', 'Q13.2', 'Q13.3', 'Q13.4', 'Q13.5', 'Q13.81', 'Q13.89', 'Q13.9', 'Q14.0', 'Q14.1', 'Q14.2', 'Q14.3', 'Q14.8', 'Q14.9', 'Q15.0', 'Q15.8', 'Q15.9', 'Q16.0', 'Q16.1', 'Q16.2', 'Q16.3', 'Q16.4', 'Q16.5', 'Q16.9', 'Q17.0', 'Q17.1', 'Q17.2', 'Q17.3', 'Q17.4', 'Q17.5', 'Q17.8', 'Q17.9', 'Q18.0', 'Q18.1', 'Q18.2', 'Q18.3', 'Q18.4', 'Q18.5', 'Q18.6', 'Q18.7', 'Q18.8', 'Q18.9', 'Q20.0', 'Q20.1', 'Q20.2', 'Q20.3', 'Q20.4', 'Q20.5', 'Q20.6', 'Q20.8', 'Q20.9', 'Q21.0', 'Q21.1', 'Q21.2', 'Q21.3', 'Q21.4', 'Q21.8', 'Q21.9', 'Q22.0', 'Q22.1', 'Q22.2', 'Q22.3', 'Q22.4', 'Q22.5', 'Q22.6', 'Q22.8', 'Q22.9', 'Q23.0', 'Q23.1', 'Q23.2', 'Q23.3', 'Q23.4', 'Q23.8', 'Q23.9', 'Q24.0', 'Q24.1', 'Q24.2', 'Q24.3', 'Q24.4', 'Q24.5', 'Q24.6', 'Q24.8', 'Q24.9', 'Q25.0', 'Q25.1', 'Q25.21', 'Q25.29', 'Q25.3', 'Q25.40', 'Q25.41', 'Q25.42', 'Q25.43', 'Q25.44', 'Q25.45', 'Q25.46', 'Q25.47', 'Q25.48', 'Q25.49', 'Q25.5', 'Q25.6', 'Q25.71', 'Q25.72'
        				, 'Q25.79', 'Q25.8', 'Q25.9', 'Q26.0', 'Q26.1', 'Q26.2', 'Q26.3', 'Q26.4', 'Q26.5', 'Q26.6', 'Q26.8', 'Q26.9', 'Q27.0', 'Q27.1', 'Q27.2', 'Q27.30', 'Q27.31', 'Q27.32', 'Q27.33', 'Q27.34', 'Q27.39', 'Q27.4', 'Q27.8', 'Q27.9', 'Q28.0', 'Q28.1', 'Q28.2', 'Q28.3', 'Q28.8', 'Q28.9', 'Q30.0', 'Q30.1', 'Q30.2', 'Q30.3', 'Q30.8', 'Q30.9', 'Q31.0', 'Q31.1', 'Q31.2', 'Q31.3', 'Q31.5', 'Q31.8', 'Q31.9', 'Q32.0', 'Q32.1', 'Q32.2', 'Q32.3', 'Q32.4', 'Q33.0', 'Q33.1', 'Q33.2', 'Q33.3', 'Q33.4', 'Q33.5', 'Q33.6', 'Q33.8', 'Q33.9', 'Q34.0', 'Q34.1', 'Q34.8', 'Q34.9', 'Q35.1', 'Q35.3', 'Q35.5', 'Q35.7', 'Q35.9', 'Q36.0', 'Q36.1', 'Q36.9', 'Q37.0', 'Q37.1', 'Q37.2', 'Q37.3', 'Q37.4', 'Q37.5', 'Q37.8', 'Q37.9', 'Q38.0', 'Q38.1', 'Q38.2', 'Q38.3', 'Q38.4', 'Q38.5', 'Q38.6', 'Q38.7', 'Q38.8', 'Q39.0', 'Q39.1', 'Q39.2', 'Q39.3', 'Q39.4', 'Q39.5', 'Q39.6', 'Q39.8', 'Q39.9', 'Q40.0', 'Q40.1', 'Q40.2', 'Q40.3', 'Q40.8', 'Q40.9', 'Q41.0', 'Q41.1', 'Q41.2', 'Q41.8', 'Q41.9', 'Q42.0', 'Q42.1', 'Q42.2', 'Q42.3', 'Q42.8', 'Q42.9', 'Q43.0', 'Q43.1', 'Q43.2', 'Q43.3', 'Q43.4', 'Q43.5', 'Q43.6', 'Q43.7', 'Q43.8', 'Q43.9'
        				, 'Q44.0', 'Q44.1', 'Q44.2', 'Q44.3', 'Q44.4', 'Q44.5', 'Q44.6', 'Q44.7', 'Q45.0', 'Q45.1', 'Q45.2', 'Q45.3', 'Q45.8', 'Q45.9', 'Q50.01', 'Q50.02', 'Q50.1', 'Q50.2', 'Q50.31', 'Q50.32', 'Q50.39', 'Q50.4', 'Q50.5', 'Q50.6', 'Q51.0', 'Q51.10', 'Q51.11', 'Q51.20', 'Q51.21', 'Q51.22', 'Q51.28', 'Q51.3', 'Q51.4', 'Q51.5', 'Q51.6', 'Q51.7', 'Q51.810', 'Q51.811', 'Q51.818', 'Q51.820', 'Q51.821', 'Q51.828', 'Q51.9', 'Q52.0', 'Q52.10', 'Q52.11', 'Q52.120', 'Q52.121', 'Q52.122', 'Q52.123', 'Q52.124', 'Q52.129', 'Q52.3', 'Q52.4', 'Q52.5', 'Q52.6', 'Q52.70', 'Q52.71', 'Q52.79', 'Q52.8', 'Q52.9', 'Q53.00', 'Q53.01', 'Q53.02', 'Q53.10', 'Q53.111', 'Q53.112', 'Q53.12', 'Q53.13', 'Q53.20', 'Q53.211', 'Q53.212', 'Q53.22', 'Q53.23', 'Q53.9', 'Q54.0', 'Q54.1', 'Q54.2', 'Q54.3', 'Q54.4', 'Q54.8', 'Q54.9', 'Q55.0', 'Q55.1', 'Q55.20', 'Q55.21', 'Q55.22', 'Q55.23', 'Q55.29', 'Q55.3', 'Q55.4', 'Q55.5', 'Q55.61', 'Q55.62', 'Q55.63', 'Q55.64', 'Q55.69', 'Q55.7', 'Q55.8', 'Q55.9', 'Q56.0', 'Q56.1', 'Q56.2', 'Q56.3', 'Q56.4', 'Q60.0', 'Q60.1', 'Q60.2', 'Q60.3', 'Q60.4', 'Q60.5', 'Q60.6', 'Q61.00', 'Q61.01', 
        				'Q61.02', 'Q61.11', 'Q61.19', 'Q61.2', 'Q61.3', 'Q61.4', 'Q61.5', 'Q61.8', 'Q61.9', 'Q62.0', 'Q62.10', 'Q62.11', 'Q62.12', 'Q62.2', 'Q62.31', 'Q62.32', 'Q62.39', 'Q62.4', 'Q62.5', 'Q62.60', 'Q62.61', 'Q62.62', 'Q62.63', 'Q62.69', 'Q62.7', 'Q62.8', 'Q63.0', 'Q63.1', 'Q63.2', 'Q63.3', 'Q63.8', 'Q63.9', 'Q64.0', 'Q64.10', 'Q64.11', 'Q64.12', 'Q64.19', 'Q64.2', 'Q64.31', 'Q64.32', 'Q64.33', 'Q64.39', 'Q64.4', 'Q64.5', 'Q64.6', 'Q64.70', 'Q64.71', 'Q64.72', 'Q64.73', 'Q64.74', 'Q64.75', 'Q64.79', 'Q64.8', 'Q64.9', 'Q65.00', 'Q65.01', 'Q65.02', 'Q65.1', 'Q65.2', 'Q65.30', 'Q65.31', 'Q65.32', 'Q65.4', 'Q65.5', 'Q65.6', 'Q65.81', 'Q65.82', 'Q65.89', 'Q65.9', 'Q66.00', 'Q66.01', 'Q66.02', 'Q66.10', 'Q66.11', 'Q66.12', 'Q66.211', 'Q66.212', 'Q66.219', 'Q66.221', 'Q66.222', 'Q66.229', 'Q66.30', 'Q66.31', 'Q66.32', 'Q66.40', 'Q66.41', 'Q66.42', 'Q66.50', 'Q66.51', 'Q66.52', 'Q66.6', 'Q66.70', 'Q66.71', 'Q66.72', 'Q66.80', 'Q66.81', 'Q66.82', 'Q66.89', 'Q66.90', 'Q66.91', 'Q66.92', 'Q67.0', 'Q67.1', 'Q67.2', 'Q67.3', 'Q67.4', 'Q67.5', 'Q67.6', 'Q67.7', 'Q67.8', 'Q68.0', 'Q68.1', 'Q68.2', 
        				'Q68.4', 'Q68.5', 'Q68.6', 'Q68.8', 'Q69.0', 'Q69.1', 'Q69.2', 'Q69.9', 'Q70.00', 'Q70.01', 'Q70.02', 'Q70.03', 'Q70.10', 'Q70.11', 'Q70.12', 'Q70.13', 'Q70.20', 'Q70.21', 'Q70.22', 'Q70.23', 'Q70.30', 'Q70.31', 'Q70.32', 'Q70.33', 'Q70.4', 'Q70.9', 'Q71.00', 'Q71.01', 'Q71.02', 'Q71.03', 'Q71.10', 'Q71.11', 'Q71.12', 'Q71.13', 'Q71.20', 'Q71.21', 'Q71.22', 'Q71.23', 'Q71.30', 'Q71.31', 'Q71.32', 'Q71.33', 'Q71.40', 'Q71.41', 'Q71.42', 'Q71.43', 'Q71.50', 'Q71.51', 'Q71.52', 'Q71.53', 'Q71.60', 'Q71.61', 'Q71.62', 'Q71.63', 'Q71.811', 'Q71.812', 'Q71.813', 'Q71.819', 'Q71.891', 'Q71.892', 'Q71.893', 'Q71.899', 'Q71.90', 'Q71.91', 'Q71.92', 'Q71.93', 'Q72.00', 'Q72.01', 'Q72.02', 'Q72.03', 'Q72.10', 'Q72.11', 'Q72.12', 'Q72.13', 'Q72.20', 'Q72.21', 'Q72.22', 'Q72.23', 'Q72.30', 'Q72.31', 'Q72.32', 'Q72.33', 'Q72.40', 'Q72.41', 'Q72.42', 'Q72.43', 'Q72.50', 'Q72.51', 'Q72.52', 'Q72.53', 'Q72.60', 'Q72.61', 'Q72.62', 'Q72.63', 'Q72.70', 'Q72.71', 'Q72.72', 'Q72.73', 'Q72.811', 'Q72.812', 'Q72.813', 'Q72.819', 'Q72.891', 'Q72.892', 'Q72.893', 'Q72.899', 'Q72.90', 'Q72.91', 
        				'Q72.92', 'Q72.93', 'Q73.0', 'Q73.1', 'Q73.8', 'Q74.0', 'Q74.1', 'Q74.2', 'Q74.3', 'Q74.8', 'Q74.9', 'Q75.0', 'Q75.1', 'Q75.2', 'Q75.3', 'Q75.4', 'Q75.5', 'Q75.8', 'Q75.9', 'Q76.0', 'Q76.1', 'Q76.2', 'Q76.3', 'Q76.411', 'Q76.412', 'Q76.413', 'Q76.414', 'Q76.415', 'Q76.419', 'Q76.425', 'Q76.426', 'Q76.427', 'Q76.428', 'Q76.429', 'Q76.49', 'Q76.5', 'Q76.6', 'Q76.7', 'Q76.8', 'Q76.9', 'Q77.0', 'Q77.1', 'Q77.2', 'Q77.3', 'Q77.4', 'Q77.5', 'Q77.6', 'Q77.7', 'Q77.8', 'Q77.9', 'Q78.0', 'Q78.1', 'Q78.2', 'Q78.3', 'Q78.4', 'Q78.5', 'Q78.6', 'Q78.8', 'Q78.9', 'Q79.0', 'Q79.1', 'Q79.2', 'Q79.3', 'Q79.4', 'Q79.51', 'Q79.59', 'Q79.60', 'Q79.61', 'Q79.62', 'Q79.63', 'Q79.69', 'Q79.8', 'Q79.9', 'Q80.0', 'Q80.1', 'Q80.2', 'Q80.3', 'Q80.4', 'Q80.8', 'Q80.9', 'Q81.0', 'Q81.1', 'Q81.2', 'Q81.8', 'Q81.9', 'Q82.0', 'Q82.1', 'Q82.2', 'Q82.3', 'Q82.4', 'Q82.5', 'Q82.6', 'Q82.8', 'Q82.9', 'Q83.0', 'Q83.1', 'Q83.2', 'Q83.3', 'Q83.8', 'Q83.9', 'Q84.0', 'Q84.1', 'Q84.2', 'Q84.3', 'Q84.4', 'Q84.5', 'Q84.6', 'Q84.8', 'Q84.9', 'Q85.00', 'Q85.01', 'Q85.02', 'Q85.03', 'Q85.09', 'Q85.1', 'Q85.8', 'Q85.9', 'Q86.0', 
        				'Q86.1', 'Q86.2', 'Q86.8', 'Q87.0', 'Q87.11', 'Q87.19', 'Q87.2', 'Q87.3', 'Q87.40', 'Q87.410', 'Q87.418', 'Q87.42', 'Q87.43', 'Q87.5', 'Q87.81', 'Q87.82', 'Q87.89', 'Q89.01', 'Q89.09', 'Q89.1', 'Q89.2', 'Q89.3', 'Q89.4', 'Q89.7', 'Q89.8', 'Q89.9', 'Q90.0', 'Q90.1', 'Q90.2', 'Q90.9', 'Q91.0', 'Q91.1', 'Q91.2', 'Q91.3', 'Q91.4', 'Q91.5', 'Q91.6', 'Q91.7', 'Q92.0', 'Q92.1', 'Q92.2', 'Q92.5', 'Q92.61', 'Q92.62', 'Q92.7', 'Q92.8', 'Q92.9', 'Q93.0', 'Q93.1', 'Q93.2', 'Q93.3', 'Q93.4', 'Q93.51', 'Q93.59', 'Q93.7', 'Q93.81', 'Q93.82', 'Q93.88', 'Q93.89', 'Q93.9', 'Q95.0', 'Q95.1', 'Q95.2', 'Q95.3', 'Q95.5', 'Q95.8', 'Q95.9', 'Q96.0', 'Q96.1', 'Q96.2', 'Q96.3', 'Q96.4', 'Q96.8', 'Q96.9', 'Q97.0', 'Q97.1', 'Q97.2', 'Q97.3', 'Q97.8', 'Q97.9', 'Q98.0', 'Q98.1', 'Q98.3', 'Q98.4', 'Q98.5', 'Q98.6', 'Q98.7', 'Q98.8', 'Q98.9', 'Q99.0', 'Q99.1', 'Q99.2', 'Q99.8', 'Q99.9', 'Z37.1', 'Z37.3', 'Z37.4', 'Z37.6', 'Z37.60', 'Z37.61', 'Z37.62', 'Z37.63', 'Z37.64', 'Z37.69', 'Z37.7'
        				)
        			AND dx_cd_type = 'df'
        		)
        	AND Dsch_Date >= @START
        	AND Dsch_Date < @END
        	AND Pt_Age <= 2
        "
    )
) %>% 
    as_tibble() %>%
    clean_names()

# DB Disconnect ----
dbDisconnect(conn = db_con)

# Write File to disc
t <- str_remove_all(Sys.Date(), pattern = "-") %>% as.character()
f_name <- paste0("congenital_malformation_",t,".csv")
f_path <- "G:\\HIM\\Lin_Prosper\\congenital_malformation\\"
write_excel_csv(
    x = query
    , path = file.path(f_path, f_name)
)

# Compose Email ----
# Files
f <- paste0(f_path, f_name)

# Open Outlook
Outlook <- COMCreate("Outlook.Application")

# Create Email
Email = Outlook$CreateItem(0)

# Set the recipeitn, subject, and body
Email[["to"]] = ""
Email[["cc"]] = ""
Email[["bcc"]] = ""
Email[["subject"]] = "Microcephaly - Congenital Malformation Peds"
Email[["body"]] = "Please see the attached for the latest report"
Email[["attachments"]]$Add(f)

# Send the email
Email$Send()

# Clost Outlook, clear the message
rm(list = ls())
