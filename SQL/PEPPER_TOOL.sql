-- INTERNAL PEPPER REPORT 2 A MORE EFFICIENT APPROACH

-- VARIABLE DECLARATION AND INITIALIZATION
DECLARE @SD DATETIME
DECLARE @ED DATETIME

SET @SD = '2014-01-01'
SET @ED = '2014-03-31'

-- SELECTION STATEMENT AS A NESTED SINGLE SELECT STATEMENT
-- A RATIO VALUE OF .9999 FOR ANY CATEGORY MEANS THAT YOU SHOULD AUDIT
-- THAT CATEGORY OF DRGs
SELECT
CASE
	WHEN A.STROKE_DENOM = 0
	THEN -789789
    WHEN CAST(A.STROKE_NUM AS FLOAT)/A.STROKE_DENOM <= 0.6667
	THEN -9999.99999
	WHEN CAST(A.STROKE_NUM AS FLOAT)/A.STROKE_DENOM >= 0.86
	THEN 9999.99999
	ELSE CAST(A.STROKE_NUM AS FLOAT)/A.STROKE_DENOM
END AS 'STROKE RATIO',
CASE
	WHEN A.RESP_DENOM = 0
	THEN -789789
    WHEN CAST(A.RESP_NUM AS FLOAT)/A.RESP_DENOM <= 0.2476
	THEN -9999.99999
	WHEN CAST(A.RESP_NUM AS FLOAT)/A.RESP_DENOM >= 0.4307
	THEN 9999.99999
	ELSE CAST(A.RESP_NUM AS FLOAT)/A.RESP_DENOM
END AS 'RESP RATIO',
CASE
	WHEN A.PN_DENOM = 0
	THEN -789789
    WHEN CAST(A.PN_NUM AS FLOAT)/A.PN_DENOM <= 0.3544
	THEN -9999.99999
	WHEN CAST(A.PN_NUM AS FLOAT)/A.PN_DENOM >= 0.5416
	THEN 9999.99999
	ELSE CAST(A.PN_NUM AS FLOAT)/A.PN_DENOM
END AS 'PN RATIO',
CASE
	WHEN A.SEPT_DENOM = 0
	THEN -789789
    WHEN CAST(A.SEPT_NUM AS FLOAT)/A.SEPT_DENOM <= 0.5702
	THEN -9999.99999
	WHEN CAST(A.SEPT_NUM AS FLOAT)/A.SEPT_DENOM >= 0.8171
	THEN 9999.99999
	ELSE CAST(A.SEPT_NUM AS FLOAT)/A.SEPT_DENOM
END AS 'SEPT RATIO',
CASE
	WHEN A.VENT_DENOM = 0
	THEN -789789
    WHEN CAST(A.VENT_NUM AS FLOAT)/A.VENT_DENOM <=0.1231
	THEN -9999.99999
	WHEN CAST(A.VENT_NUM AS FLOAT)/A.VENT_DENOM >= 0.2567
	THEN 9999.99999
	ELSE CAST(A.VENT_NUM AS FLOAT)/A.VENT_DENOM
END AS 'VENT RATIO',
-- ONLY THE NATIONAL 80TH PERCENTILE ARE AVAILABLE FOR THE FOLLOWING
CASE
	WHEN A.TIA_DENOM = 0
	THEN -789789
    WHEN CAST(A.TIA_NUM AS FLOAT)/A.TIA_DENOM >= 0.3623
	THEN 9999.99999
	ELSE CAST(A.TIA_NUM AS FLOAT)/A.TIA_DENOM
END AS 'TIA RATIO',
CASE
	WHEN A.COPD_DENOM = 0
	THEN -789789
    WHEN CAST(A.COPD_NUM AS FLOAT)/A.COPD_DENOM >= 0.3571
	THEN 9999.99999
	ELSE CAST(A.COPD_NUM AS FLOAT)/A.COPD_DENOM
END AS 'COPD RATIO',
CASE
	WHEN A.SYNCOPE_DENOM = 0
	THEN -789789
    WHEN CAST(A.SYNCOPE_NUM AS FLOAT)/A.SYNCOPE_DENOM >= 0.1229
	THEN 9999.99999
	ELSE CAST(A.SYNCOPE_NUM AS FLOAT)/A.SYNCOPE_DENOM
END AS 'SYNCOPE RATIO',
CASE
	WHEN A.BACK_DENOM = 0
	THEN -789789
    WHEN CAST(A.BACK_NUM AS FLOAT)/A.BACK_DENOM >= 0.3939
	THEN 9999.99999
	ELSE CAST(A.BACK_NUM AS FLOAT)/A.BACK_DENOM
END AS 'BACK RATIO'

-- THE NESTED SELECT STATEMENT
FROM
    (SELECT 
	COUNT(CASE
	        WHEN DRG_NO IN(061,062,063,064,065,066) 
		    THEN DRG_NO END) AS STROKE_NUM,
	COUNT(CASE
	        WHEN DRG_NO IN(061,062,063,064,065,066,067,068,069)
		    THEN DRG_NO END) AS STROKE_DENOM,
	COUNT(CASE
	        WHEN DRG_NO IN(177,178)
			THEN DRG_NO END) AS RESP_NUM,
	COUNT(CASE
	        WHEN DRG_NO IN(177,178,179,193,194,195)
			THEN DRG_NO END) AS RESP_DENOM,
    COUNT(CASE
	        WHEN DRG_NO IN(193,194)
			THEN DRG_NO END) AS PN_NUM,
	COUNT(CASE
			WHEN DRG_NO IN(190,191,192,193,194,195)
			THEN DRG_NO END) AS PN_DENOM,
	COUNT(CASE
			WHEN DRG_NO IN(870, 871, 872)
			THEN DRG_NO END) AS SEPT_NUM,
	COUNT(CASE
			WHEN DRG_NO IN(689,690,870,871,872)
			THEN DRG_NO END) AS SEPT_DENOM,
	COUNT(CASE
			WHEN DRG_NO IN(003,004,207,870,927,933)
			THEN DRG_NO END) AS VENT_NUM,
	COUNT(CASE
			WHEN DRG_NO IN(003,004,207,208,870,871,872,929,933,934)
			THEN DRG_NO END) AS VENT_DENOM,
	COUNT(CASE
			WHEN DRG_NO IN(069)
			THEN DRG_NO END) AS TIA_NUM,
	COUNT(CASE
			WHEN DRG_NO IN(061,062,063,064,065,066,067,068,069)
			THEN DRG_NO END) AS TIA_DENOM,
	COUNT(CASE
			WHEN DRG_NO IN(190,191,192)
			THEN DRG_NO END) AS COPD_NUM,
	COUNT(CASE
			WHEN DRG_NO >=175 AND DRG_NO <= 208
			THEN DRG_NO END) AS COPD_DENOM,
	COUNT(CASE
			WHEN DRG_NO IN(312)
			THEN DRG_NO END) AS SYNCOPE_NUM,
	COUNT(CASE
			WHEN DRG_NO >= 208 AND DRG_NO <=316
			THEN DRG_NO END) AS SYNCOPE_DENOM,
	COUNT(CASE
			WHEN DRG_NO IN(551,552)
			THEN DRG_NO END) AS BACK_NUM,
	COUNT(CASE
			WHEN DRG_NO >= 533 AND DRG_NO <= 566
			THEN DRG_NO END) AS BACK_DENOM
			
	FROM SMSDSS.BMH_PLM_PTACCT_V PAV
	JOIN SMSDSS.PYR_DIM_V PDV
	ON PAV.PYR1_CO_PLAN_CD = PDV.SRC_PYR_CD
		AND PAV.Regn_Hosp = PDV.orgz_cd	
	WHERE DRG_NO IN (
	  061,062,063,064,065,066,067,068,069,
	  177,178,179,193,194,195,190,191,689,
	  690,870,871,872,003,004,207,208,870,
	  871,872,929,933,934,061,062,063,064,
	  065,066,067,068,069,175,176,180,181,
	  182,183,184,185,186,187,188,189,192,
	  196,197,198,199,200,201,202,203,204,
	  205,206,207,208,209,210,211,212,213,
	  214,215,216,217,218,219,220,221,222,
	  223,224,225,226,227,228,229,230,231,
	  232,233,234,235,236,237,238,239,240,
	  241,242,243,244,245,246,247,248,249,
	  250,251,252,253,254,255,256,257,258,
	  259,260,261,262,263,264,265,266,267,
	  268,269,270,271,272,273,274,275,276,
	  277,278,279,280,281,282,283,284,285,
	  286,287,288,289,290,291,292,293,294,
	  295,296,297,298,299,300,301,302,303,
	  304,305,306,307,308,309,310,311,312,
	  313,314,315,316,533,534,535,536,537,
	  538,539,540,541,542,543,544,545,546,
	  547,548,549,550,551,552,553,554,555,
	  556,557,558,559,560,561,562,563,564,
	  565,566
	  )
	AND ADM_DATE BETWEEN @SD AND @ED
	AND PLM_PT_ACCT_TYPE = 'I'
	AND PDV.PYR_CD = 'A14'
	)A